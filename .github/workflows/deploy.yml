name: Deploy Backend to Cloud Server

on:
  push:
    branches:
      - main
    paths:
      - 'app/**'
      - 'requirements.txt'
      - 'deployment/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY || secrets.SEDI_DEPLOY_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST || '91.107.168.130' }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST || '91.107.168.130' }} \
              "echo 'SSH connection successful âœ…'"

      - name: Deploy to server
        run: |
          ssh -o StrictHostKeyChecking=no \
              -o BatchMode=yes \
              -o ConnectTimeout=10 \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST || '91.107.168.130' }} << 'ENDSSH'
            set -e
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to backend directory
            cd /var/www/sedi/backend
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from Git..."
            git pull origin main || {
              echo "âŒ Git pull failed"
              exit 1
            }
            
            # Check if virtual environment exists
            if [ ! -d ".venv" ]; then
              echo "âš ï¸  Virtual environment not found, creating..."
              python3 -m venv .venv
            fi
            
            # Activate virtual environment and install/update dependencies
            echo "ðŸ“¦ Checking dependencies..."
            source .venv/bin/activate
            pip install --quiet --upgrade pip
            pip install --quiet -r requirements.txt || {
              echo "âš ï¸  Some dependencies failed to install, continuing..."
            }
            
            # Restart service
            echo "ðŸ”„ Restarting service..."
            systemctl restart sedi-backend || {
              echo "âŒ Service restart failed"
              exit 1
            }
            
            # Wait for service to start
            sleep 5
            
            # Check service status
            echo "ðŸ“Š Checking service status..."
            systemctl status sedi-backend --no-pager | head -15 || {
              echo "âŒ Service status check failed"
              exit 1
            }
            
            # Test API endpoint
            echo "ðŸ§ª Testing API endpoint..."
            if curl -f -s http://localhost:8000/ > /dev/null; then
              echo "âœ… API endpoint is responding"
            else
              echo "âš ï¸  API endpoint test failed (service may still be starting)"
            fi
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Verify deployment
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 3
          
          # Test external API access
          API_RESPONSE=$(curl -s -f http://${{ secrets.SERVER_HOST || '91.107.168.130' }}:8000/ || echo "FAILED")
          
          if [ "$API_RESPONSE" != "FAILED" ]; then
            echo "âœ… External API is accessible"
            echo "$API_RESPONSE" | head -5
          else
            echo "âš ï¸  External API test failed (may be firewall issue)"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.SERVER_HOST || '91.107.168.130' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi

